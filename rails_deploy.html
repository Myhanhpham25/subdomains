<body>
<section id="main_content">
  <div id="section_content">
    <div class="content_block">
      <div id="module_container">
        <div class="module_content module_content_block">
                <div class="module_description active_lesson active_lesson_with_video check_for_cache"><h1>Deploying your Rails Application to Amazon EC2</h1><h5>Prerequisites:</h5><ul style="line-height: 18px;">
<li>Basic Ruby/Rails knowledge</li><li>Basic Terminal knowledge</li><li>Basic Git knowledge</li><li>AWS Free Tier account. You can sign up at:&nbsp;<a href="http://aws.amazon.com/free/" target="_blank">http://aws.amazon.com/free/</a></li></ul><h2>Overview:</h2><p style="line-height: 18px;">To successfully deploy our rails application, we will need to install the following into our cloud server:</p><ul style="line-height: 18px;">
<li>Ruby, RubyGems, Rails</li><li>Git: We will use Git and Github to clone our project</li><li>Nginx: Nginx is a very popular and reliable web server; however it cannot serve Ruby web applications out of the box. To solve this issue, we must integrate Phusion Passenger. Passenger will allow our Rails application to speak HTTP.</li><li>Phusion Passenger: Passenger will be our application server that will interact with Nginx and Ruby application.</li><li>Our Database:<ul><li>PostgreSQL or</li><li>SQLite3</li></ul></li></ul><p style="line-height: 18px;">For more information about Passenger:</p><p style="line-height: 18px;"><a href="https://www.phusionpassenger.com/library/walkthroughs/basics/ruby/fundamental_concepts.html" target="_blank">https://www.phusionpassenger.com/library/walkthroughs/basics/ruby/fundamental_concepts.html</a></p><hr style="line-height: 1.5em;">
<h2>Setting Up Cloud Server and Connecting</h2><p style="line-height: 18px;">1. Once you AWS account is created, let's login to the console at aws.amazon.com/console. Choose EC2 under the <strong>Compute Category.</strong></p><h2><span style="font-weight: normal;"></span></h2><p style="line-height: 18px;"><img src="http://i62.tinypic.com/2jeqkpk.png"></p><p style="line-height: 18px;">2. In the EC2 dashboard, let's click the large blue button that says "<strong>Launch Instance</strong>"</p><p style="line-height: 18px;"><img src="http://i.imgur.com/zJEoKJj.png"></p><p style="line-height: 18px;">3. Now we need to choose an Amazon Machine Image(AMI). The machine that we will be using is <strong>Ubuntu Server 14.04</strong>. This machine should be offered by Amazon for free.</p><p style="line-height: 18px;"><strong>**IMPORTANT**: Do not select Ubuntu Server 16.04! Ubuntu 14.04 may be located towards the bottom.</strong></p><p style="line-height: 18px;"><img src="http://i.imgur.com/JfLCwYQ.png"></p><p style="line-height: 18px;">4. Now we get to choose how powerful we want this computer to be. Let's go with the<em>&nbsp;t2.micro </em>which is the only free tier eligible instance. Click on "<strong>Next: Configure Instance Details</strong>" so that we can make more configurations. We will be using mostly default configurations but is good to know what you are able to customize</p><p style="line-height: 18px;"><img src="http://i60.tinypic.com/2rms09s.png"></p><p style="line-height: 18px;">5. We won't be changing any of the default configurations for our instance details. Click <strong>"Next: Add Storage"</strong></p><p style="line-height: 18px;"><img src="http://i62.tinypic.com/9vgxol.png"></p><p style="line-height: 18px;">6. This is where we want to specify how much storage we want. We will only need 8 GB for now. Click on "<strong>Next: Tag Instance".</strong></p><p style="line-height: 18px;"><img src="http://i62.tinypic.com/2lms8b5.png"></p><p style="line-height: 18px;">7. We can give our instance a name by "tagging" it. We don't need to worry about tagging an instance for now. Click on <strong>"Next: Configure Security Group".</strong></p><p style="line-height: 18px;"><img src="http://i58.tinypic.com/vpe2l2.png"></p><p style="line-height: 18px;">8. Now in the Configure Security Group page, you have the option to create a new security group. Under this <strong>Security Group</strong>, the default allowed traffic is SSH with a protocol of TCP, this means that we can only access this instance via SSH (PUTTY for windows users) or the Terminal for macs. We want to allow HTTP as well.</p><p style="line-height: 18px;"><img src="http://i.imgur.com/MJxhS0q.png"></p><p style="line-height: 18px;">9. Amazon will warn us that our EC2 instance might not be very secure. However, for our first instance, our EC2 is secure enough. Go Ahead and click<strong> launch.</strong></p><p style="line-height: 18px;">10. One last step, we need to create and download a new key pair. This is a virtual KEY that will allow us to connect to our server.</p><ul style="line-height: 18px;">
<li>Create new Key-Pair when launching and download it. Move the key-pair into your local machine root folder (whichever folder we move the key-pair into is the folder that we need to be in to connect with our EC2&nbsp;instance)</li></ul><p style="line-height: 18px;"><img src="http://i62.tinypic.com/razpu9.png"></p><ul>
<li>Now in your terminal, change the file permission by running<em> "<strong>chmod 400 &lt;key.pem&gt;</strong>".</em></li><li>Now we will connect into our cloud server using ssh. In the terminal, run "<em><strong>ssh -i &lt;key.pem&gt; ubuntu@&lt;public.ip.address&gt;</strong>".</em></li><li>It will ask if you are sure to continue connecting: <strong>yes</strong><img src="http://i.imgur.com/Qt7rY6W.png" style="background-color: initial;"></li></ul><p style="line-height: 18px;">Now we should be connected to our cloud server. The user in the terminal that should be:<em> "ubuntu@ip-your-private-address"</em>. Once connected, we need to update Ubuntu. For this, we will use Ubuntu's Advanced Packaging Tool (APT)</p><ul style="line-height: 18px;">
<li>In your terminal, run<em> "<strong>sudo apt-get update</strong>".</em></li></ul><h2>
<hr></h2><h2>Installing Ruby, Rails and Phusion Passenger</h2><p style="line-height: 18px;">Since we are deploying a Ruby on Rails application we also need to install RVM (Ruby Version Manager). RVM will help us manage and install Ruby</p><ul>
<li>Install RVM<ul>
<li>First we need to download the<em> gpg</em> signatures:<ul>
<li>In your terminal, run<em> "<strong>gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3</strong>"</em></li></ul></li><li>Next we will actually run the command to install RVM.<ul>
<li>In your terminal, run "<em><strong>\curl -sSL https://get.rvm.io | bash -s stable</strong>"</em></li></ul></li><li>Next we will load RVM.<ul>
<li>In your terminal, run<em> "<strong>source ~/.rvm/scripts/rvm</strong>".</em></li></ul></li><li>Next we will check the requirements for ubuntu and install any packages missing.<ul>
<li>In your terminal, run<em> "<strong>rvm requirements</strong>".</em></li></ul></li><li>Next we will update our system with the required dependencies for ruby. There are a lot of them so this command will be long. <strong>This is optional if rvm requirements successfully installed all the dependencies.</strong><ul>
<li>In your terminal, run<em> "<strong>rvmsudo /usr/bin/apt-get install build-essential openssl libreadline6 libreadline6-dev curl git-core zlib1g zlib1g-dev libssl-dev libyaml-dev libsqlite3-dev sqlite3 libxml2-dev libxslt-dev autoconf libc6-dev ncurses-dev automake libtool bison subversion</strong>".</em></li><li>Press Y to continue.</li></ul></li></ul></li></ul><p style="line-height: 18px;">Great Job! You have successfully installed RVM. Now RVM will help us install Ruby and RubyGems. Also, we will install Rails</p><ul>
<li>First, we will run a couple of commands to install Ruby in our system<ul>
<li>Ruby<ul>
<li>In your terminal, run<em> "<strong>rvm install 2.3.1</strong>"</em> - This will install Ruby (you may replace the number with the latest version of Ruby).</li><li>In your terminal, run <em>"<strong>rvm use 2.3.1 --default</strong>"</em>. This will set the default ruby version to the specified version</li><li>Run "ruby -v" and it should give us the version that we have installed, so we know that it was successfully installed</li></ul></li></ul></li><li>Next, install Ruby Gems<ul>
<li>In your terminal, run <em>"<strong>rvm rubygems current</strong>". </em>If it asks you to update the a more current version, you can run "<strong>rvm rubygems current --force"</strong></li></ul></li><li>Installing Rails<ul>
<li>In your terminal run. <em>"<strong>gem install rails -v 4.2 --no-ri --no-rdoc</strong>" </em>By specifying that we don't want to install<em> ri </em>or <em>rdoc</em> documentation, we will accelerate the installation of Rails in our system</li></ul></li></ul><p style="line-height: 18px;">Awesome. Now that we have Ruby and Rails installed. Our next step is to install Phusion Passenger</p><ul style="line-height: 18px;">
<li>Phusion Passenger is an application which can directly integrate into Nginx (the web server that we will be using for our application). Passenger will help us prepare to launch our Ruby on Rails application instances<ul>
<li>Now let's run,<em> "<strong>gem install passenger</strong>".</em></li></ul></li></ul><hr>
<h2>Nginx</h2><p style="line-height: 18px;">Great! Now we have Ruby and Rails in our system, along with the passenger gem. Next, let's&nbsp;install our web server: Nginx</p><ul style="line-height: 18px;">
<li>In our terminal, let's run<em> "<strong>rvmsudo passenger-install-nginx-module</strong>". </em>This will bring up some options in our terminal.<img src="http://i.imgur.com/dpnKcje.png" style="background-color: initial;"></li><li>Press Enter and it will ask what&nbsp;language&nbsp;we are interested in. We will select (use space bar) Ruby and Node.js. And press enter. This will check if we have all the required software to install Nginx for our languages.&nbsp;<p><img src="http://i.imgur.com/chPxxwo.png">&nbsp;</p></li><li>If Passenger is not able to install curl, it will tell us the command that we need to do so. Let's follow its instructions and run <em>"<strong>sudo&nbsp;apt-get install libcurl4-openssl-dev</strong>"</em>. After the curl is installed, run <em>"<strong>rvmsudo passenger-install-nginx-module</strong>"</em> again</li><li>After this, we should get a message telling us that we do not have a lot of virtual memory. We can follow passenger's recommendations. What we need to do is create a swap space for more virtual memory. More specifically, we will create a file with 1M of memory that will turn into a swap space.</li></ul><p style="margin-left: 60px; line-height: 18px;"><img src="http://i.imgur.com/3F6so12.png"></p><ul style="line-height: 18px;">
<li>So we will abort this installer and create&nbsp;more virtual memory. Let us run the following commands.<ul>
<li><strong>Ctrl-C</strong> to exit installation</li><li>To create the virtual memory file we run <em>"<strong>sudo dd if=/dev/zero of=/swap bs=1M count=1024</strong>"</em></li><li>Now, let's turn the file into actual space by running <em>"<strong>sudo mkswap /swap</strong>"</em></li><li>Lastly, let's turn the swap space on, run<em> "<strong>sudo swapon /swap</strong>"</em><ul><li>If you encounter a permissions error: "insecure permissions 0644, 0600 suggested" then:<ul><li>Change permissions: <strong>"<em>sudo chmod 0600 /swap"</em></strong></li><li>Turn off swap:&nbsp;<strong></strong><em>"<strong>sudo swapoff /swap</strong>"</em></li><li>Turn it back on:&nbsp;<em>"<strong>sudo swapon /swap</strong>"</em></li></ul></li></ul></li></ul></li></ul><p style="margin-left: 40px; line-height: 18px;"><img src="http://i.imgur.com/E78Lp4Z.png"></p><ul style="line-height: 18px;">
<li>Now let's run <em>"<strong>rvmsudo passenger-install-nginx-module</strong>" </em>and follow Passenger's direction like we did before. We should not have any more issues during our installation.</li><li>Passenger will ask us if we want it to download, compile and install Nginx for us. In this step, we will enter our choice as "<strong>1</strong>".&nbsp;</li></ul><p style="line-height: 18px;"><img src="http://i.imgur.com/nsD81p5.png"></p><ul style="line-height: 18px;">
<li>Then, it will ask us where we would like to install Nginx. The prefix directory will be <em>"<strong>/etc/nginx</strong>".&nbsp;</em></li></ul><p style="line-height: 18px;"><img src="http://i.imgur.com/PSVmAqP.png"></p><ul style="line-height: 18px;">
<li>Congratulations! We have installed Nginx!</li></ul><p style="line-height: 18px;"><img src="http://i.imgur.com/vmf0wrj.png"></p><h2>
<hr></h2><h2>PostgreSQL (if you wish to use SQLite3, skip to the next step)</h2><p style="line-height: 18px;">We will be deploying the Rails version of the WALL assignment. Note, that this application will use PostgreSql as the database. If your application uses SQlite or another database such as MySql, you will need to install the appropriate dependencies or switch the database to PostgreSQL.</p><p style="line-height: 18px;">So let's install PostgresSQL and its development libraries:</p><ul style="line-height: 18px;">
<li>In your terminal, run<em> "<strong>sudo apt-get install postgresql postgresql-contrib libpq-dev</strong>". </em>Press Y when the terminal asks for more space.</li></ul><p style="line-height: 18px;">Now we will set up a PostgreSQL superuser user.</p><ul style="line-height: 18px;">
<li>In your terminal, let's run <em>"<strong>sudo su postgres -c psql</strong>".</em> This should bring up the Postgres prompt.<br>
<ul>
<li>Now let's create the user. This username should be the same username that you have in Rails application. You can check the username at: <em>"your_rails_project/config/database.yml".</em></li><li>In the terminal, let's run "<strong>CREATE ROLE ubuntu SUPERUSER LOGIN;</strong>"&nbsp;<strong>(DO NOT FORGET THE SEMICOLON AFTER YOUR STATEMENT)</strong>.</li></ul><p>This is how your terminal should look like:<img src="http://i.imgur.com/D4Y1nG6.png" style="background-color: initial;">&nbsp;And this is our <em style="background-color: initial;">database.yml </em>file in our rails project. Notice the<strong> USERNAME: UBUNTU</strong> in the default block</p></li></ul><p>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;<img src="http://s3.amazonaws.com/General_V88/boomyeah/company_209/chapter_3441/handouts/chapter3441_6997_db.png" style="width: 546px;"></p><hr>
<h2>Installing NodeJS, Git and Downloading Rails Application</h2><p style="line-height: 18px;">Very nice! Before we configure our Nginx server we will import our Rails Project using Git and GitHub. As you might have guessed, we need to install Git. We are also going to install NodeJS, so that we avoid getting a javascript runtime error from the Asset Pipeline</p><ul style="line-height: 18px;">
<li>Let's run,<em> "<strong>sudo apt-get install nodejs</strong>".</em></li><li>Let's run, "<em><strong>sudo apt-get install git</strong></em>".</li><li>In our terminal, let's navigate to "<strong>cd /var"</strong> and create a directory named <em>www </em>by running the command <em>"<strong>sudo mkdir www</strong>". </em>Then, we will navigate into the directory we just created by running <em>"<strong>cd www</strong>".</em> This directory is where we are going to have our application.</li></ul><p style="margin-left: 20px; line-height: 18px;"><img src="http://i.imgur.com/wjNoEjp.png" style="width: 597px;"></p><ul>
<li>Now we will clone the application from the GitHub repository.&nbsp;<strong>Reminder</strong>: If you are using <strong>PostgreSQL,&nbsp;</strong>make sure that your<em> database.yml</em> file is set up as above when we installed PostgreSQL.<br>
<ul>
<li>In your terminal, run<em> "<strong>sudo git clone https://github.com/&lt;yourusername&gt;/&lt;your_rails_project&gt;</strong>".</em></li></ul></li></ul><p style="line-height: 18px;"><img src="http://i.imgur.com/t81mrpJ.png"></p><ul style="line-height: 18px;">
<li>Next, let's change the ownership of our rails project to our<em> ubuntu </em>user.<ul>
<li>In the terminal, run<em> "<strong>sudo chown -R ubuntu your_rails_project</strong>"</em>. Let's navigate into our project and run "<strong>bundle install</strong>"</li></ul></li></ul><p style="line-height: 18px;"><img src="http://i.imgur.com/xs68Scn.png"></p><ul style="line-height: 18px;">
<li>Now let's create a log file to record development.<br>
<ul>
<li>In the terminal let's run <em>"<strong>sudo touch log/development.log</strong>".</em> Also, let's change the permission of the log file. Run <em>"<strong>sudo chmod 0666&nbsp;/var/www/&lt;your_rails_project&gt;/log/development.log</strong>"</em></li></ul></li></ul><p style="line-height: 18px;"><img src="http://i.imgur.com/ewwlGX5.png"></p><ul style="line-height: 18px;">
<li>Next, let's create the databases and run our migrations.<ul>
<li>Only if you are using <strong>PostgreSQL</strong>, run&nbsp;<em>"<strong>rake db:create:all</strong>".</em></li><li>Run<em> "<strong>rake db:migrate</strong>". </em>No matter what kind of database.</li></ul></li></ul><p style="line-height: 18px;">If you are using <strong>PostgreSQL</strong>, we can run<em>&nbsp;"rails db" to see our</em>&nbsp;development database in the terminal. Next run<em> "\d" </em>for the list of tables. If you are using <strong>SQLite3</strong>, you can just go to the <em>rails console.</em></p><p style="line-height: 18px;"><img src="http://i.imgur.com/eZzbyRZ.png"></p><hr>
<h2>Starting and Configuring Nginx</h2><p style="line-height: 18px;">Congratulations! We are almost there. Now we will download a Nginx start up script and make it executable.</p><ul style="line-height: 18px;">
<li>To get the Nginx start up script, run <em>"<strong>sudo wget https://raw.github.com/JasonGiedymin/nginx-init-ubuntu/master/nginx -O /etc/init.d/nginx</strong>"</em></li></ul><p style="line-height: 18px;"><img src="http://i.imgur.com/PkT0x0Z.png"></p><ul style="line-height: 18px;">
<li>Now let's make it executable. run&nbsp;<em>"<strong>sudo chmod +x /etc/init.d/nginx</strong>"</em></li><li>Next, let's navigate to Nginx file by running <em>"<strong>cd /etc/init.d</strong>"</em> and then<em> "</em><em><strong>sudo vi nginx</strong>"</em></li><li>To insert in vim press <em>"i" </em>key<ul>
<li>Change line 21 to<em> "<strong>/etc/nginx/conf/nginx.conf</strong>"</em></li><li>Change line 22 to <em>"<strong>/etc/nginx/logs/nginx.pid</strong>"</em></li></ul></li></ul><p style="line-height: 18px;"><img src="http://i.imgur.com/6A2HtEu.png"></p><ul style="line-height: 18px;">
<ul>
<li>Change line 87 to "<span style="color: rgb(51, 51, 51); font-family: Verdana; font-size: 13.3333px; white-space: pre-wrap;"><strong>NGINXPATH=${NGINXPATH:-/etc/nginx}</strong>"</span></li></ul></ul><p style="line-height: 18px;"><img src="http://i.imgur.com/6pRSvEL.png"></p><ul style="line-height: 18px;">
<li>Now, let's save the file. Press <em>ESC</em>, and then&nbsp;<em>:</em><em>wq</em></li><li>Let's see if it works now. Run<em> "<strong>sudo service nginx start</strong>"</em>. We should get [ OK ]</li></ul><p style="line-height: 18px;">Now, we need to configure our Nginx server.</p><ul style="line-height: 18px;">
<li>Let's navigate to <em>"<strong>cd /etc/nginx</strong>"</em></li><li>Let's make two directories. One for sites available and another one for sites enabled.<ul>
<li>Run<em>"<strong>sudo mkdir sites-available</strong>"</em> and <em>"<strong>sudo mkdir sites-enabled</strong>"</em></li></ul></li><li>Navigate to the conf directory. Run <em>"cd conf"</em></li><li>Let's make some changes in the file. Run<em> "<strong>sudo vi nginx.conf</strong>"</em><ul>
<li>Below the server section type<em>&nbsp;"<strong>include /etc/nginx/sites-enabled/*;</strong>" </em>. I will be writing it after line 82. Then escape and<em> :</em><em>wq </em>out of the file.</li></ul></li></ul><p style="line-height: 18px;"><img src="http://i.imgur.com/MSi8ef9.png"></p><ul style="line-height: 18px;">
<li>Now, let's navigate to <em>"/etc/nginx/sites-available"</em> and create <i class="">rails</i><em>.conf</em> file<ul>
<li>Run <em>"<strong>cd /etc/nginx/sites-available</strong>"</em></li><li>Then<em>, "<strong>sudo touch rails.conf</strong>"</em></li><li>Now we will write in our file,<em> "<strong>sudo vi rails.conf</strong>"</em></li><li>This will be our code:&nbsp;<ul>
<li>server {<br>&nbsp; &nbsp; &nbsp; listen 80;&nbsp;<br>&nbsp; &nbsp; &nbsp; server_name &lt;your-EC2-public-ip&gt; &lt;your.domainname.com&gt;;&nbsp;<br>&nbsp; &nbsp; &nbsp; passenger_enabled on;&nbsp;<br>&nbsp; &nbsp; &nbsp; passenger_app_env development;&nbsp;<br>&nbsp; &nbsp; &nbsp; root /var/www/&lt;your_app_name&gt;/public;<br>&nbsp; &nbsp; &nbsp; }</li><li>Dont forget to write and quit<em> - :wq</em></li></ul></li></ul></li></ul><p style="line-height: 18px;"><img src="http://i.imgur.com/Zbm8EO7.png" style="background-color: initial;"></p><ul style="line-height: 18px;">
<li>Now, let's create a symbolic link between the directories<em> "sites-enabled"</em> and<em> "sites-available"</em><ul>
<li>Run, <em>"<strong>sudo ln -s /etc/nginx/sites-available/rails.conf /etc/nginx/sites-enabled/rails.conf"</strong></em></li></ul></li><li>Restart Nginx by running<em> "<strong>sudo service nginx restart</strong>".</em> We should get two [ OK ]'s</li></ul><p style="line-height: 18px;"><img src="http://i.imgur.com/vGyLAub.png"></p><h2>Final Step</h2><p style="line-height: 18px;">Awesome. the last step is to point your domain name to the ip address from AWS EC2</p><ul style="line-height: 18px;">
<li>In this case, we will be using GoDaddy. Go to <strong>Manage your domain &gt; DNS zone file</strong>. And change the<em> @ record's </em>IP address to EC2's public IP address and save the changes. It may take couple of minutes for GoDaddy to update your IP address.</li></ul><p style="line-height: 18px;"><img src="http://i.imgur.com/J8OELMG.png"></p><p style="line-height: 18px;">DONE! Great job. Now go to your domain name and the application should be online.</p><p style="line-height: 18px;"><img src="http://i.imgur.com/WSZ9c3w.png"></p></iframe></div> 
</body>